# 代理

Web 代理（proxy）服务器是网络的中间实体。代理位于客户端与服务器之间，扮演“中间人”的角色，在各断点之间来回传送 HTTP 报文。
- 公共代理
    - 比如高速缓存代理服务器；
- 代理的用途
    - 儿童过滤器；
    - 文档访问控制；
    - 安全防火墙；
    - Web 缓存；
    - 反向代理：代理可以假扮 Web 服务器。这些被称为反向代理（reverse-proxy）的代理接收发给 Web 服务器的真实请求，但与 Web 服务器不同的是，它们可以发起与其他服务器的通信，以便按需定位所请求的内容。
    - 内容路由器：根据因特网流量状况以及内容类型将请求导向特定的 Web 服务器；
    - 转码器：代理服务器在将内容发送给客户端之前，可以修改内容的主体格式；（例如传输 GIF 图片时，转成 JPEG 格式以减小尺寸）
    - 匿名者：匿名者代理会主动从 HTTP 报文中删除身份特性，从而提供高度的私密性和匿名性；

## 代理会去往何处

- 代理服务器的部署
    - 出口代理：可以将代理固定在本地网络的出口点，以便控制本地网络与大型因特网之间的流量。（访问限制）
    - 访问（入口）代理：代理常被放在 ISP 访问点上，用以处理来自客户的聚合请求。ISP 使用缓存代理来存储常用文档的副本，以提高用户的下载速度，降低因特网带宽耗费；
    - 反向代理：代理通常会被部署在网络边缘，在 Web 服务器之前，作为反向代理在那里它们可以处理所有传送给 Web 服务器的请求，并只在必要时向 Web 服务器请求资源。反向代理可以提高 Web 服务器的安全特性，或者将快速的的 Web 服务器缓存放在较慢的服务器之前，以提高性能。反向代理通常会直接冒用 Web 服务器的名字和 IP 地址，这样所有的请求就会被发送给代理而不是服务器了。
    - 网络交换代理；
- 代理的层次结构
    - 可以通过代理层次结构将代理级联起来。在代理的层次结构中，会将报文从一个代理传给另一个代理，直到最终抵达原始服务器为止。
    - Proxy 层次结构中的代理服务器被赋予了父与子的关系。下一个入口代理（靠近服务器）被称为父代理，下一个出口代理（靠近客户端）被称为子代理。
    - 动态选择父代理
        - 如果所请求的对象属于一个付费使用内容分发服务的 Web 服务器，代理就会将请求发送给附近的一个缓存服务器，这个服务器会返回已缓存对象，或者如果它那儿没有的话，它会去取回内容。
        - 如果请求的是特定类型的图片，访问代理会将请求转发给一个特定的压缩代理，这个代理会去获取图片，然后对其进行压缩，这样通过到客户端的慢速 Modem 下载时，速度会更快一些。
    - 动态选择父代理的例子
        - 负载均衡：子代理可能会根据当前父代理上的工作负载级别来决定如何选择一个父代理，以均衡负载。
        - 地理位置附近的路由：子代理可能会选择负责原始服务器所在物理区域的父代理；
        - 协议/类型路由；
        - 基于订购的路由；
- 代理是如何获取流量的
    - 修改客户端：很多 Web 客户端，包括网景和微软的服务器，都支持手工和自动的代理配置。如果将客户端配置为使用代理服务器，客户端就会将 HTTP 请求有意地直接发送给代理，而不是原始服务器。
    - 修改网络：网络基础设置可以通过若干种技术手段，在客户端不知道，或没有参与的情况下，拦截网络流量并将其导入代理。这种拦截通常都依赖于监视 HTTP 流量的交换设备及路由设备，在客户端毫不知情的情况下，对其进行拦截，并将流量导入一个代理。这种代理被称为拦截代理。
    - 修改 DNS 的命名空间：放在 Web 服务器之前的代理服务器——反向代理，会直接假扮 Web 服务器的名字和 IP 地址，这样，所有的请求就会发送给这些反向代理，而不是服务器了。要实现这一点，可以手工编辑 DNS 名称列表，或者用特殊的动态 DNS 服务器根据需要来确定适当的代理和服务器。
    - 修改 Web 服务器：也可以将某些 Web 服务器配置为向客户端发送一条 HTTP 重定向命令（响应码 305），将客户端请求重定向到一个代理上去。收到重定向命令后，客户端会与代理进行通信。

## 客户端的代理设置

- 手工配置：显示地设置要使用的代理；
- 预先配置浏览器；
- 代理的自动配置（Proxy Auto-Configuration, PAC）
    - 提供一个 URI，指向一个用 Javascript 语言编写的代理自动配置文件；客户端会取回这个 Javascript 文件，并运行它以决定是否应该使用一个代理，如果是的话，应该使用哪个代理服务器。
- WPAD 的代理发现

## 追踪报文

- 现在，在将 Web 请求从客户端传送到服务器的路径上，经过两个或多个代理是很常见的。比如，出于安全和节省费用的考虑，很多公司都会用缓存代理服务器来访问因特网。
- Via 首部字段列出了与报文途径的每个中间节点（代理或网关）有关的信息；
- Server 响应首部字段对原始服务器使用的软件进行了描述。如果响应报文是通过代理转发的，一定要确保代理没有修改 Server 首部。Server 首部是用于原始服务器的。代理应该添加的是 Via 条目。

- TRACE 方法
    - 通过 HTTP/1.1 的 TRACE 方法，用户可以跟踪经代理传输的请求报文，观察报文经过了哪些代理，以及每个代理是如何对请求报文进行修改的。TRACE 对代理流的调试非常有用。